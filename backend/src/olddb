from pymongo import MongoClient, errors
from datetime import datetime
import os

class Database:
	def __init__(self):
		self.client = None
		self.db = None
		self.sensor_station = None
		self.statement = None
		self.init_db()


	def init_db(self):
		try:
			self.client = MongoClient(host='mongodb', port=27017, serverSelectionTimeoutMS=5000)
			self.client.server_info()
			self.db = self.client['METEO_CENTER']
			print(f"Base de données sélectionnée : {self.db.name}")
			self.sensor_station = self.db['Sensor_Station']
			self.statement = self.db['Statement']
			print(f"Collections disponibles : {self.db.list_collection_names()}")
			print("Connexion à la base de données réussie")
		except errors.ServerSelectionTimeoutError as err:
			print(f"Erreur de connexion à la base de données : {err}")

	def retrieve_statements(self):
		try:
			results = self.statement.find({})
			statements = list(results)
			print(f"Nombre de documents trouvés : {len(statements)}")
			return statements  # Convertit le curseur en liste de dictionnaires
		except errors.PyMongoError as e:
			print(f"Erreur lors de la récupération des données : {e}")
			return []

	def adding_sensor_station(self, mac_id, secret_key, city):
		if self.sensor_station is not None:
			creation_date = date.today().strftime("%d-%m-%Y")
			sensor_station_data = {
				"Mac_id": mac_id,
				"Secret_Key": secret_key,
				"City": city,
				"Creation_date": creation_date
			}
			try:
				result = self.sensor_station.insert_one(sensor_station_data)
				print(f"Entrée ajoutée avec l'ID : {result.inserted_id}")
				return result.inserted_id
			except errors.PyMongoError as e:
				print(f"Erreur lors de l'insertion des données : {e}")
				return 0
		else:
			print("La collection 'Sensor_Station' n'est pas disponible")
			return 0

	def adding_statement(self, secret_key, temperature, humidity, pressure):
		if self.sensor_station is not None :
			query = {"Secret_Key": secret_key}
			sensor_station = self.sensor_station.find_one(query)
			if sensor_station:
				id_sensor_station = sensor_station.get("_id")
				if self.statement is not None:
					date = date.now().strftime("%d-%m-%Y")
					time = date.now().strftime("%H:%M:%S")
					statement_data = {
						"Id_Sensor_Station_F": id_sensor_station,
						"Temperature": temperature,
						"Humidity": humidity,
						"Pressure": pressure,
						"Date": date,
						"Time": time
					}
					try:
						result = self.statement.insert_one(statement_data)
						print(f"Données transmises avec succès.\r ID : {result.inserted_id}")
						return 1
					except errors.PyMongoError as e:
						print(f"Erreur lors de l'insertion des données : {e}")
						return 0
				else:
					print("La collection 'Statement' n'est pas disponible")
					return 0
		else:
			print("La collection 'Sensor_Station' n'est pas disponible")
			return 0


	def print_collections(self):
		try:
			print("Collections disponibles dans la base de données :")
			collections = self.db.list_collection_names()
			for collection in collections:
				print(collection)
		except errors.PyMongoError as e:
			print(f"Erreur lors de la récupération des collections : {e}")
